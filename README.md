# Wallet Service Application

## Описание
Это RESTful приложение, которое реализует функциональность 
для создания и управления кошельками с возможностью пополнения и снятия средств.
Приложение использует базу данных PostgreSQL для хранения информации
о кошельках и транзакциях.

Проект также включает в себя миграции базы данных с использованием Liquibase, 
а также запускается и работает в контейнерах Docker с помощью `docker-compose`.

## Технологии
- **Java 17**
- **Spring Boot 3.x**
- **PostgreSQL**
- **Liquibase** для миграций
- **Docker** для контейнеризации приложения и базы данных
- **JUnit 5** для тестирования
- **Mockito** для мокирования зависимостей
- **Spring Data JPA** для работы с базой данных

## Установка

### Шаг 1: Клонирование репозитория

Склонируйте репозиторий с помощью Git:

```bash
git clone https://github.com/IronTommy/wallet-service.git

cd wallet-service
```

###  Шаг 2: Настройка окружения
Приложение использует переменные окружения для настройки подключения к базе данных.

Пример:

spring:
  datasource:
    url:
jdbc:postgresql://localhost:5432/wallet_db
    username: postgres
    password: postgres
  jpa:
    hibernate:
      ddl-auto: none
    show-sql: true
  liquibase:
    enabled: true
    change-log: classpath:db/changelog/db.changelog-master.xml

### Шаг 3: Запуск приложения в Docker
Проект полностью контейнеризован с помощью Docker. Для запуска приложения и базы данных
с помощью docker-compose выполните следующие шаги:

Перейдите в директорию с проектом и создайте контейнеры:

docker-compose up --build

Приложение будет доступно по адресу: http://localhost:8080

База данных будет работать на порту 5432.

### Шаг 4: Проверка работы приложения
Приложение доступно через REST API. Для проверки работы приложения выполните следующие действия:

# 1. Создание кошелька
(POST /api/v1/wallets)
Для создания нового кошелька, отправьте POST-запрос с уникальным идентификатором кошелька.

Пример запроса:

{
  "walletId": "550e8400-e29b-41d4-a716-446655440000"
}

Пример ответа (успех):

{
  "status": "Wallet created successfully"
}

# 2. Выполнение операции с кошельком
(POST /api/v1/wallets/operations)
Для выполнения операции (депозит или снятие средств) с кошельком, отправьте POST-запрос с указанием кошелька,
типа операции и суммы.

## Пример запроса (депозит):

{
  "walletId": "550e8400-e29b-41d4-a716-446655440000",
  "operationType": "DEPOSIT",
  "amount": 1000
}

### Пример ответа (успех):

{
  "status": "Success",
  "balance": 1000
}

### Пример ответа (ошибка, если недостаточно средств для снятия):

{
  "error": "Insufficient funds"
}

## Пример запроса (снятие):
{
"walletId": "550e8400-e29b-41d4-a716-446655440000",
"operationType": "WITHDRAW",
"amount": 500
}

### Пример ответа (успех):

{
"status": "Success",
"balance": 500
}

# 3. Получение баланса кошелька
(GET /api/v1/wallets/{walletId})
Для получения баланса кошелька по его уникальному идентификатору.

Пример запроса:

GET http://localhost:8080/api/v1/wallets/550e8400-e29b-41d4-a716-446655440000

Пример ответа (успех):

{
  "balance": 1000
}

Пример ответа (ошибка, если кошелек не найден):

{
  "error": "Wallet not found"
}

### Шаг 5: Остановка контейнеров
Чтобы остановить все контейнеры, связанные с проектом, выполните команду:

docker-compose down

Эта команда остановит все контейнеры, но сохранит данные, так как используется том для базы данных.

Если вы хотите полностью удалить данные, включая том, используйте команду:

docker volume rm wallet-wallet-data

# Архитектура приложения

## Контроллеры
Контроллеры обрабатывают HTTP-запросы для создания кошельков и выполнения операций с кошельками.

POST /api/v1/wallet — создаёт новый кошелек.
POST /api/v1/wallets/operations — выполняет операцию с кошельком (депозит или снятие).
GET /api/v1/wallets/{walletId} — возвращает текущий баланс кошелька.

## Сервисный слой
Сервисный слой выполняет бизнес-логику для создания кошельков, обработки операций и управления транзакциями.

## Репозиторий
Используется Spring Data JPA для работы с PostgreSQL. Репозиторий предоставляет стандартные методы для создания и
обновления кошельков и транзакций.

## Миграции с Liquibase
Для управления схемой базы данных используется Liquibase, который автоматически применяет миграции при запуске 
приложения.

## Тестирование
Тесты покрывают функциональность API, а также логику сервисного слоя. Для тестирования контроллеров используется
MockMvc, а для сервисного слоя — Mockito.

### Разработка и тестирование

Запуск тестов
Для запуска тестов используйте команду:

./mvnw test
Для запуска тестов контроллеров используйте команду:

./mvnw test -Dtest=WalletControllerTest
Для запуска тестов сервисного слоя:

./mvnw test -Dtest=WalletServiceTest

## Проблемы с производительностью

В случае работы с высокой нагрузкой (например, 1000 RPS), приложение использует оптимистичное блокирование (@Version)
и аннотацию @Retryable для автоматического повторного выполнения операций в случае конфликтов, что помогает избежать
ошибок при параллельных запросах.

## Пример миграций с Liquibase
Миграции базы данных выполнены с использованием Liquibase в файле db.changelog-master.xml:

## Логирование
Приложение использует SLF4J и Logback для логирования. Логи содержат информацию о запросах, транзакциях и возникающих
ошибках.

# Заключение
Вы можете использовать это приложение для управления кошельками с высокой нагрузкой и надежностью. Все важные аспекты, 
такие как обработка ошибок и работа с конкурентными запросами, были учтены. Приложение полностью контейнеризовано с 
помощью Docker и легко масштабируемо.

## Если у вас возникнут вопросы или предложения по улучшению, не стесняйтесь обращаться.

Этот файл `README.md` предоставляет все необходимые инструкции для работы с проектом, его настройки и запуск в Docker.
